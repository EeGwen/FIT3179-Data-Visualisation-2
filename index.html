<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Monthly Air Pollution — Multi-line Vega-Lite & GHG Grouped Bar Chart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Vega / Vega-Lite / Vega-Embed -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <!-- d3 to load CSV -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 20px; }
    .controls { display: flex; gap: 24px; align-items: flex-start; margin-bottom: 12px; flex-wrap: wrap; }
    .control-group { border: 1px solid #eee; padding: 10px; border-radius: 6px; background: #fafafa; }
    #chart, #ghg-chart { margin-top: 10px; }
    label { margin-right: 8px; user-select: none; }
    .small-note { font-size: 0.9em; color: #666; margin-top:6px; }
    hr { border: none; border-top: 1px solid #eee; }
    ul { margin-top:6px; margin-bottom:6px; padding-left:18px; }
  </style>
</head>
<body>
  <!-- Multi-line Chart (existing) -->
  <h1>Monthly Air Pollution — Multi-line Chart</h1>

  <div class="controls">
    <div class="control-group" id="pollutant-controls">
      <strong>Pollutant (choose one)</strong>
      <div id="pollutant-radios">
        <!-- Radios populated by JS -->
      </div>
    </div>

    <div class="control-group" id="year-controls">
      <strong>Year(s) (choose one or more)</strong>
      <div id="year-checkboxes" style="display:flex; flex-direction: column; gap:6px;">
        <!-- Year checkboxes populated by JS -->
      </div>
      <div class="small-note">Select multiple years to compare; colors represent years.</div>
    </div>

    <div class="control-group">
      <strong>Actions</strong><br>
      <button id="reset-btn">Reset (all years, first pollutant)</button>
    </div>
  </div>

  <div id="chart"></div>

  <!-- ---------- GHG Grouped Bar Chart (NEW) ---------- -->
  <hr style="margin:28px 0;">
  <h1>Annual greenhouse gas (GHG) emissions by source — Grouped Bar Chart</h1>

  <div class="controls" style="margin-bottom:6px;">
    <div class="control-group" id="ghg-year-controls" style="min-width:260px;">
      <strong>Year(s) (choose one or more)</strong>
      <div id="ghg-year-checkboxes" style="display:flex; flex-direction: column; gap:6px; margin-top:8px;">
        <!-- Year checkboxes populated by ghg_grouped_bar JS -->
      </div>
      <div class="small-note">Select multiple years to compare; colors represent years.</div>
    </div>

    <div class="control-group" style="max-width:560px;">
      <strong>How is this data produced?</strong>
      <p style="margin-top:6px; margin-bottom:6px;">
        Official data on GHG emissions is compiled by the Ministry of Natural Resources and Environmental Sustainability (NRES), following IPCC guidelines for national greenhouse gas inventories. Emissions are derived from multiple sectors including energy, industrial processes, agriculture, waste, and LULUCF (land use, land-use change, forestry).
      </p>
      <div id="ghg-source-legend" class="small-note"></div>
    </div>
  </div>

  <div id="ghg-chart"></div>
  <!-- ---------- end GHG chart ---------- -->

  <!-- Inline JS: multi-line script (vega_air_pollution.js content) -->
  <script>
  // vega_air_pollution.js (inlined)
  const CSV_URL = "https://raw.githubusercontent.com/EeGwen/FIT3179-Data-Visualisation-2/refs/heads/main/air_pollution_with_month_year.csv";
  const MONTH_ORDER = ["January","February","March","April","May","June","July","August","September","October","November","December"];

  // Vega-Lite spec template; JS will set data.values = filteredData
  const baseSpec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "description": "Monthly concentration (Jan-Dec) for selected pollutant across selected years. Color = year.",
    "width": 800,
    "height": 420,
    "data": { "values": [] },
    "mark": { "type": "line", "point": true, "clip": true },
    "encoding": {
      "x": { "field": "month", "type": "ordinal", "axis": { "title": "Month" }, "scale": { "domain": MONTH_ORDER } },
      "y": { "field": "concentration_num", "type": "quantitative", "axis": { "title": "Concentration" } },
      "color": { "field": "year", "type": "nominal", "legend": { "title": "Year" } },
      "detail": [ { "field": "year" }, { "field": "pollutant" } ],
      "tooltip": [
        { "field": "pollutant", "type": "nominal", "title": "Pollutant" },
        { "field": "year", "type": "nominal", "title": "Year" },
        { "field": "month", "type": "ordinal", "title": "Month" },
        { "field": "concentration_num", "type": "quantitative", "title": "Concentration" }
      ]
    }
  };

  // load CSV and initialize UI + chart
  d3.csv(CSV_URL).then(function(rawData) {
    const data = rawData.map(d => ({
      date: d.date,
      pollutant: d.pollutant ? d.pollutant.trim() : d.pollutant,
      concentration_num: d.concentration === "" || d.concentration == null ? null : +d.concentration,
      month: d.month ? d.month.trim() : d.month,
      year: d.year ? String(d.year).trim() : d.year
    }));

    // remove rows with missing concentration
    const cleaned = data.filter(d => d.concentration_num !== null && !isNaN(d.concentration_num));

    // unique lists
    const pollutants = Array.from(new Set(cleaned.map(d => d.pollutant))).filter(Boolean).sort();
    const years = Array.from(new Set(cleaned.map(d => d.year))).filter(Boolean).sort();

    // build pollutant radio buttons (single select)
    const pollContainer = document.getElementById("pollutant-radios");
    pollutants.forEach((p, idx) => {
      const id = "radio-" + p.replace(/\s+/g, "_");
      const wrapper = document.createElement("div");
      wrapper.style.marginBottom = "6px";
      // radio input name is same to enforce single selection
      wrapper.innerHTML = `<label><input type="radio" name="pollutant" id="${id}" value="${p}" ${idx === 0 ? 'checked' : ''}> ${p}</label>`;
      pollContainer.appendChild(wrapper);
    });

    // build year checkboxes (multi select) for the multi-line chart
    const yearContainer = document.getElementById("year-checkboxes");
    years.forEach((y) => {
      const id = "year-" + y;
      const wrapper = document.createElement("div");
      wrapper.style.marginBottom = "6px";
      wrapper.innerHTML = `<label><input type="checkbox" id="${id}" value="${y}" checked> ${y}</label>`;
      yearContainer.appendChild(wrapper);
    });

    // reset button behavior: select first pollutant and all years
    document.getElementById("reset-btn").addEventListener("click", function() {
      // check first pollutant radio
      const firstRadio = document.querySelector('input[name="pollutant"]');
      if (firstRadio) firstRadio.checked = true;
      // check all years
      yearContainer.querySelectorAll('input[type="checkbox"]').forEach(ch => ch.checked = true);
      render();
    });

    // attach event listeners
    pollContainer.addEventListener("change", render);
    yearContainer.addEventListener("change", render);

    // initial render
    render();

    function render() {
      // selected pollutant (single)
      const selectedPollRadio = document.querySelector('input[name="pollutant"]:checked');
      const selectedPollutant = selectedPollRadio ? selectedPollRadio.value : null;

      // selected years (array)
      const selectedYears = Array.from(yearContainer.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.value);

      // validations
      if (!selectedPollutant) {
        document.getElementById("chart").innerHTML = "<p style='color:#666;'>Please select a pollutant (choose one).</p>";
        return;
      }
      if (selectedYears.length === 0) {
        document.getElementById("chart").innerHTML = "<p style='color:#666;'>Please select at least one year.</p>";
        return;
      }

      // filter data for selected pollutant and years
      const filtered = cleaned.filter(d => d.pollutant === selectedPollutant && selectedYears.includes(d.year));

      if (filtered.length === 0) {
        document.getElementById("chart").innerHTML = "<p style='color:#666;'>No data for the selected pollutant/year combination.</p>";
        return;
      }

      // prepare spec with filtered data: color = year
      const spec = JSON.parse(JSON.stringify(baseSpec));
      spec.data = { values: filtered };

      // embed
      vegaEmbed("#chart", spec, { actions: true, renderer: "canvas" })
        .then(result => {
          // optional: keep result.view if you want to update without re-embedding
        })
        .catch(err => {
          console.error("vegaEmbed error:", err);
          document.getElementById("chart").innerHTML = "<p style='color:red;'>Error rendering chart — see console.</p>";
        });
    }

  }).catch(err => {
    console.error("Error loading CSV:", err);
    document.getElementById("chart").innerHTML = "<p style='color:red;'>Failed to load CSV. See console.</p>";
  });
  </script>

  <!-- Inline JS: GHG grouped bar chart -->
  <script>
  // GHG grouped bar chart (inlined JSON spec + JS)
  const GHG_CSV_URL = "https://raw.githubusercontent.com/EeGwen/FIT3179-Data-Visualisation-2/refs/heads/main/ghg_emissions_with_year.csv";

  const SOURCE_LABELS = {
    "total": "Total Emissions (excluding LULUCF)",
    "net": "Net Emissions (including LULUCF)",
    "energy": "Energy",
    "industrial_processes": "Industrial Processes",
    "agriculture": "Agriculture",
    "waste": "Waste"
  };

  // Vega-Lite JSON spec (template). data.values will be set in JS.
  const ghgSpecTemplate = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "title": {
      "text": "Annual greenhouse gas (GHG) emissions by source",
      "subtitle": "X = Source ; Y = Emissions"
    },
    "width": 800,
    "height": 420,
    "data": { "values": [] },
    "mark": {
      "type": "bar",
      "tooltip": true,
      "clip": true
    },
    "encoding": {
      "x": {
        "field": "source",
        "type": "nominal",
        "axis": { "title": "Source (short code)", "labelAngle": 0 }
      },
      "xOffset": { "field": "year", "type": "nominal" },
      "y": {
        "field": "emissions_num",
        "type": "quantitative",
        "axis": { "title": "Emissions" }
      },
      "color": {
        "field": "year",
        "type": "nominal",
        "legend": { "title": "Year" }
      },
      "tooltip": [
        { "field": "source", "type": "nominal", "title": "Source (code)" },
        { "field": "source_full", "type": "nominal", "title": "Source (full)" },
        { "field": "year", "type": "nominal", "title": "Year" },
        { "field": "emissions_num", "type": "quantitative", "title": "Emissions" }
      ]
    }
  };

  // Load CSV and render
  (function initGHG() {
    d3.csv(GHG_CSV_URL).then(raw => {
      // remove possible duplicate header row in CSV and clean fields
      const parsed = raw
        .filter(r => !(r.date && String(r.date).toLowerCase() === "date" && r.source && String(r.source).toLowerCase() === "source"))
        .map(d => ({
          date: d.date,
          source: d.source ? d.source.trim() : d.source,
          emissions_num: d.emissions === "" || d.emissions == null ? null : +d.emissions,
          year: d.year ? String(d.year).trim() : d.year,
          source_full: SOURCE_LABELS[d.source ? d.source.trim() : ""] || d.source
        }))
        .filter(d => d.emissions_num !== null && !isNaN(d.emissions_num) && d.source && d.year);

      if (parsed.length === 0) {
        document.getElementById("ghg-chart").innerHTML = "<p style='color:red;'>No GHG data found.</p>";
        return;
      }

      // unique years (sorted)
      const years = Array.from(new Set(parsed.map(d => d.year))).sort();

      // populate year checkboxes (with an All toggle)
      const yearContainer = document.getElementById("ghg-year-checkboxes");
      yearContainer.innerHTML = ""; // clear

      const allId = "ghg-year-all";
      const allWrapper = document.createElement("div");
      allWrapper.style.marginBottom = "6px";
      allWrapper.innerHTML = `<label><input type="checkbox" id="${allId}" checked> All</label>`;
      yearContainer.appendChild(allWrapper);

      years.forEach((y) => {
        const id = "ghg-year-" + y;
        const wrapper = document.createElement("div");
        wrapper.style.marginBottom = "6px";
        wrapper.innerHTML = `<label><input type="checkbox" id="${id}" value="${y}" checked> ${y}</label>`;
        yearContainer.appendChild(wrapper);
      });

      // add source legend mapping under chart
      const legendDiv = document.getElementById("ghg-source-legend");
      legendDiv.innerHTML = "<strong>Source codes:</strong>";
      const ul = document.createElement("ul");
      ul.style.marginTop = "6px";
      ul.style.marginBottom = "12px";
      Object.entries(SOURCE_LABELS).forEach(([k,v])=>{
        const li = document.createElement("li");
        li.textContent = `${k} — ${v}`;
        ul.appendChild(li);
      });
      legendDiv.appendChild(ul);

      // event: yearCheckbox changes
      yearContainer.addEventListener("change", (event) => {
        const allBox = document.getElementById(allId);
        if (event && event.target && event.target.id === allId) {
          // toggled All — set all other boxes to same state
          const checked = allBox.checked;
          yearContainer.querySelectorAll('input[type="checkbox"]').forEach(ch => { ch.checked = checked; });
        } else {
          // if not the All box, update All box state
          const yearBoxes = Array.from(yearContainer.querySelectorAll('input[type="checkbox"]')).filter(i => i.id !== allId);
          const allChecked = yearBoxes.every(b => b.checked);
          allBox.checked = allChecked;
        }
        renderGHG();
      });

      // initial render
      renderGHG();

      function renderGHG() {
        // selected years
        const selectedYears = Array.from(yearContainer.querySelectorAll('input[type="checkbox"]:checked'))
          .map(i => i.value)
          .filter(Boolean); // remove the All (which has no value)

        if (selectedYears.length === 0) {
          document.getElementById("ghg-chart").innerHTML = "<p style='color:#666;'>Please select at least one year for the GHG grouped bar chart.</p>";
          return;
        }

        // filter rows for selected years
        const filtered = parsed.filter(d => selectedYears.includes(d.year));

        if (filtered.length === 0) {
          document.getElementById("ghg-chart").innerHTML = "<p style='color:#666;'>No GHG data for the selected year(s).</p>";
          return;
        }

        // prepare spec: deep copy and attach data.values
        const spec = JSON.parse(JSON.stringify(ghgSpecTemplate));
        spec.data = { values: filtered };

        // embed the chart into #ghg-chart
        vegaEmbed("#ghg-chart", spec, { actions: true, renderer: "canvas" })
          .then(result => {
            // keep result.view if you want to do dynamic updates without re-embedding
          })
          .catch(err => {
            console.error("Error embedding GHG chart:", err);
            document.getElementById("ghg-chart").innerHTML = "<p style='color:red;'>Error rendering GHG chart. See console.</p>";
          });
      }

    }).catch(err => {
      console.error("Error loading GHG CSV:", err);
      document.getElementById("ghg-chart").innerHTML = "<p style='color:red;'>Failed to load GHG CSV. See console.</p>";
    });
  })();
  </script>

</body>
</html>
