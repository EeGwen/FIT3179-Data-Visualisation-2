<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Air Pollution</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/vega@5.20.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.1.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.17.0"></script>

  <script src="https://d3js.org/d3.v7.min.js"></script>

  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<h2 class="main-title">Air Pollution</h2>

<!-- Tabs (non-sticky) -->
<div class="tabs-wrapper" aria-label="Navigation tabs for graphs">
  <div class="tabs" role="tablist" id="graph-tabs">
    <button class="tab" role="tab" data-target="#world-aqi-container" aria-controls="world-aqi-container">Worldwide Overview</button>
    <button class="tab" role="tab" data-target="#map" aria-controls="map">Malaysia AQI</button>
    <button class="tab" role="tab" data-target="#chart" aria-controls="chart">Monthly Air Pollution</button>
    <button class="tab" role="tab" data-target="#ghg-chart" aria-controls="ghg-chart">Causes</button>
    <button class="tab active" role="tab" data-target="#aqi-cases-container" aria-controls="aqi-cases-container">Impact</button>
  </div>
</div>
<!-- ====== End tabs ====== -->

<!-- ===== World Average AQI map ===== -->
<div class="graph-container" id="world-aqi-container">
  <h1>Global Distribution of Average Air Quality Index (AQI) by Country</h1>

  <div class="visual-row" aria-label="World average AQI map with description">
    <!-- left: map -->
    <div class="visual-left">
      <div id="world-map" aria-live="polite" role="img" aria-label="World map showing average AQI by country"></div>
      <div class="small-note" style="margin-top:1px;"> 
        Countries with insufficient station coverage are marked with coverage info.
      </div>
    </div>

    <!-- right: text box with manual line breaks (max 10 words per line) -->
    <div class="visual-right">
      <div class="textbox" id="world-map-text" aria-label="Explanation of the world AQI map">
        <!-- Spacer between paragraphs -->
        <div class="line" style="height:0.6rem;"></div>

        <div class="line">The highest levels of air pollution,</div>
        <div class="line">reaching Hazardous and Unhealthy</div>
        <div class="line">categories, are prominently seen in</div>
        <div class="line">East, Central, and South Asia.</div>

        <div class="line">Conversely, large portions of the</div>
        <div class="line">Americas, Europe, and Australia/Oceania fall</div>
        <div class="line">within the Good air quality range.</div>

        <!-- Spacer between paragraphs -->
        <div class="line" style="height:0.6rem;"></div>

        <div class="line">The substantial number of countries categorised</div>
        <div class="line">as Unhealthy underscores the widespread public</div>
        <div class="line">health challenge posed by air pollution globally.</div>
      </div>
    </div>
  </div>
</div>
<!-- ====================================================================== -->

<!-- ===== Malaysia Monthly AQI Map ===== -->
<div class="graph-container">
  <h1>Monthly Distribution of Air Quality Levels Across Malaysia in 2022</h1>
  <div class="subtitle">An interactive monthly snapshot of urban air quality across the country.</div>

  <div class="controls" id="map-controls">
    <!-- Month select: no "All" option — user must pick a month -->
    <div class="control-group">
      <strong>Month</strong>
      <select id="filter-month"></select>
    </div>
    <div class="control-group">
      <strong>Actions</strong><br>
      <button id="map-reset">Reset filter</button>
      <div class="small-note" style="margin-top:8px;">Choose a month to see API distribution for that month.</div>
    </div>
  </div>

  <div class="visual-row">
    <div class="visual-left">
      <div id="map"></div>
    </div>
    <div class="visual-right">
      <div class="textbox" id="map-description" aria-label="Map description">
        <div class="headline">Map overview</div>

        <!-- First paragraph (each line ≤ 10 words) -->
        <div class="line">This interactive map provides a detailed,</div>
        <div class="line">month-by-month analysis of air pollution</div>
        <div class="line">across Malaysian cities in 2022.</div>
        <div class="line">It reveals that while Malaysia generally avoids</div>
        <div class="line">the most extreme levels of air pollution,</div>
        <div class="line">but air quality for most urban people</div>
        <div class="line">is consistently classified as 'Moderate'.</div>

        <!-- Spacer between paragraphs -->
        <div class="line" aria-hidden="true" style="height:8px;"></div>

        <!-- Second paragraph (each line ≤ 10 words) -->
        <div class="line">The true value of this visualization</div>
        <div class="line">is in observing the temporal shifts;</div>
        <div class="line">use the month filter to identify</div>
        <div class="line">periods of improvement or degradation,</div>
        <div class="line">highlighting impacts of seasonal weather patterns</div>
        <div class="line">and specific pollution events during the year.</div>
      </div>
    </div>
  </div>
</div>

<!-- MONTHLY (multiline) chart: left graph + right text box -->
<div class="graph-container">
  <h1>Monthly Air Pollution</h1>
  <div class="controls">
    <div class="control-group" id="pollutant-controls">
      <strong>Pollutant (choose one)</strong>
      <div id="pollutant-radios"></div>
    </div>
    <div class="control-group" id="year-controls">
      <strong>Year(s) (choose one or more)</strong>
      <div id="year-checkboxes" style="display:flex; flex-direction: column; gap:6px;"></div>
      <div class="small-note">Select multiple years to compare; colors represent years.</div>
    </div>
    <div class="control-group">
      <strong>Actions</strong><br>
      <button id="reset-btn">Reset (all years, first pollutant)</button>
    </div>
  </div>

  <div class="visual-row">
    <div class="visual-left">
      <div id="chart"></div>
    </div>
    <div class="visual-right">
      <div class="textbox" id="chart-description" aria-label="Monthly air pollution description">
        <div class="headline">Monthly Air Pollution Overview</div>
        <div class="line">This multiline graph shows monthly air pollution</div>
        <div class="line">trends in Malaysia from 2017 to 2022, focusing</div>
        <div class="line">on different pollutants such as CO, NO₂, and O₃.</div>
        <div class="line">Each colored line represents a specific year,</div>
        <div class="line">helping to visualize changes over time.</div>
        <div class="line">This visualization helps viewers compare pollution</div>
        <div class="line">patterns across years, identify seasonal variations,</div>
        <div class="line">and recognize any unusual peaks or declines that</div>
        <div class="line">could be linked to environmental or policy changes.</div>
      </div>
    </div>
  </div>
</div>

<!-- GHG grouped bar: left graph + right text box -->
<div class="graph-container">
  <h1>Annual greenhouse gas (GHG) emissions by source</h1>
  <div class="controls" style="margin-bottom:6px;">
    <div class="control-group" id="ghg-year-controls" style="min-width:260px;">
      <strong>Year(s) (choose one or more)</strong>
      <div id="ghg-year-checkboxes" style="display:flex; flex-direction: column; gap:6px; margin-top:8px"></div>
      <div class="small-note">Select multiple years to compare; colors represent years.</div>
    </div>
    <div class="control-group" style="max-width:560px;">
      <strong>How is this data produced?</strong>
      <p style="margin-top:6px; margin-bottom:6px;">
        Official data on GHG emissions compiled by Ministry of Natural Resources and Environmental Sustainability.
      </p>
      <div id="ghg-source-legend" class="small-note"></div>
    </div>
  </div>

  <div class="visual-row">
    <div class="visual-left">
      <div id="ghg-chart"></div>
    </div>
    <div class="visual-right">
      <div class="textbox" id="ghg-description" aria-label="GHG description">
        <div class="headline">GHG emissions summary</div>
        <div class="line">From the graph, it is evident that</div>
        <div class="line">the energy sector consistently contributes the</div>
        <div class="line">largest share of GHG emissions, followed by</div>
        <div class="line">net emissions, while agriculture and</div>
        <div class="line">waste contribute relatively smaller amounts.</div>
        <div class="line">There is a slight upward trend in</div>
        <div class="line">net and industrial process emissions toward 2021,</div>
        <div class="line">suggesting increased industrial activity or energy demand</div>
        <div class="line">over time.</div>
      </div>
    </div>
  </div>
</div>

<!-- ================== AQI vs Respiratory/Cardiovascular scatter ================== -->
<div class="graph-container" id="aqi-cases-container">
  <h1>AQI vs Health Cases</h1>

  <div class="small-note" style="margin-bottom:10px;">
    Select which health outcome to view on the y-axis. Points and regression show the relationship between AQI (x) and the chosen case count (y).
  </div>

  <div class="controls" style="align-items:center; margin-bottom:8px;">
    <div class="control-group" style="display:flex; flex-direction:column; gap:10px;">
      <strong>Choose outcome</strong>
      <div class="single-circle-selector" id="case-selector">
        <!-- Note: input order: input -> .radio-ui -> colored legend dot -> label text -->
        <label class="circle-radio">
          <input type="radio" name="caseType" value="respiratory" checked>
          <span class="radio-ui" aria-hidden="true"></span>
          <span class="circle-dot" id="dot-resp" style="background:#1f77b4;"></span>
          <span class="label">Respiratory Cases</span>
        </label>

        <label class="circle-radio">
          <input type="radio" name="caseType" value="cardio">
          <span class="radio-ui" aria-hidden="true"></span>
          <span class="circle-dot" id="dot-cardio" style="background:#ff7f0e;"></span>
          <span class="label">Cardiovascular Cases</span>
        </label>
      </div>
      <div class="small-note">Single selection (circular radio): choose either Respiratory or Cardiovascular.</div>
    </div>
  </div>

  <div id="aqi-cases-scatter" style="width:100%; min-height:520px;"></div>
  <div id="aqi-cases-note" class="small-note" style="margin-top:8px;"></div>
</div>

<!-- ================== External JS files ================== -->
<!-- World AQI map -->
<script src="world_map.js"></script>
<!-- You can add other external JS files for tabs, charts, GHG, etc. here -->
</body>
</html>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // ------------------------------- Tabs initialization (unchanged) -------------------------------
  (function setupTabs() {
    const tabContainer = document.getElementById('graph-tabs');
    if(!tabContainer) return;
    const tabs = Array.from(tabContainer.querySelectorAll('.tab'));
    const sections = tabs.map(t => {
      const sel = t.getAttribute('data-target');
      const el = document.querySelector(sel);
      return {tab: t, target: el};
    }).filter(d => d.target);

    tabs.forEach(tab => {
      tab.addEventListener('click', (e) => {
        const targetSel = tab.getAttribute('data-target');
        const target = document.querySelector(targetSel);
        if(target){
          target.scrollIntoView({behavior:'smooth', block:'start'});
          try { target.focus({preventScroll:true}); } catch(e){}
          setActiveTab(tab);
        }
      });
      tab.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          tab.click();
        }
      });
    });

    function setActiveTab(activeTab){
      tabs.forEach(t => t.classList.toggle('active', t === activeTab));
    }

    const observerOptions = {
      root: null,
      rootMargin: '0px 0px -40% 0px',
      threshold: 0
    };

    const visibleSections = new Map();

    function onIntersection(entries){
      entries.forEach(entry => {
        visibleSections.set(entry.target, entry.isIntersecting ? entry.intersectionRatio : 0);
      });

      let best = null;
      for(const [sec, val] of visibleSections.entries()){
        if(best === null || val > visibleSections.get(best)){
          best = sec;
        }
      }
      if(best){
        const pair = sections.find(s => s.target === best);
        if(pair) setActiveTab(pair.tab);
      }
    }

    const observer = new IntersectionObserver(onIntersection, observerOptions);
    sections.forEach(s => { if(s.target) observer.observe(s.target); });

    window.addEventListener('load', () => {
      let current = null;
      for(const s of sections){
        const rect = s.target.getBoundingClientRect();
        if(rect.top >= 0 && rect.top < window.innerHeight * 0.6){
          current = s; break;
        }
      }
      if(current) setActiveTab(current.tab);
      else if(tabs.length) tabs[0].classList.add('active');
    });

    tabs.forEach(t => t.setAttribute('tabindex', '0'));
  })();

  // ---------------- Malaysia Map ----------------
  const MAP_CSV = "https://raw.githubusercontent.com/EeGwen/FIT3179-Data-Visualisation-2/refs/heads/main/data/Air-Pollution-Index-in-Malaysia-monthly.csv";
  const VG_JSON_PATH = "js/malaysia_map_aqi.vg.json"; // <- externalized Vega-Lite spec

  // Load CSV, build months and cleaned data
  d3.csv(MAP_CSV).then(raw => {
    const cleaned = raw.map(r => ({
      Month: String(r.Month||""),
      City: String(r.City||""),
      State: String(r.State||""),
      Latitude: r.Latitude ? +r.Latitude : null,
      Longitude: r.Longitude ? +r.Longitude : null,
      API: r["Air Quality Index"] ? +r["Air Quality Index"] : (r.API ? +r.API : null),
      "Air Pollution Level": r["AQI Category"] || r["Air Pollution Level"] || "",
      Observations: r.Observations ? (+r.Observations) : (r.Observation ? (+r.Observation) : null)
    }));

    const withCoords = cleaned.filter(d => d.Latitude != null && d.Longitude != null && !isNaN(d.Latitude) && !isNaN(d.Longitude));

    const months = Array.from(new Set(withCoords.map(d => d.Month))).filter(Boolean)
      .sort((a,b) => ["January","February","March","April","May","June","July","August","September","October","November","December"].indexOf(a)
                    - ["January","February","March","April","May","June","July","August","September","October","November","December"].indexOf(b));

    function populateSelect(selEl, values){
      selEl.innerHTML = "";
      values.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.text = v;
        selEl.appendChild(opt);
      });
      if(values.length > 0) selEl.value = values[0];
    }

    populateSelect(document.getElementById("filter-month"), months);

    document.getElementById("map-reset").addEventListener("click", () => {
      const sel = document.getElementById("filter-month");
      if(sel.options.length > 0) sel.value = sel.options[0].value;
      renderMap();
    });
    document.getElementById("filter-month").addEventListener("change", renderMap);

    // Load the external Vega-Lite spec JSON once
    let mapSpecTemplate = null;
    fetch(VG_JSON_PATH).then(resp => {
      if(!resp.ok) throw new Error("Unable to load Vega spec: " + resp.statusText);
      return resp.json();
    }).then(specJson => {
      mapSpecTemplate = specJson;
      // initial render
      renderMap();
    }).catch(err => {
      console.error("Failed to load map spec JSON:", err);
      const el = document.getElementById("map");
      if (el) el.innerHTML = "<p style='color:#b00;'>Failed to load map specification.</p>";
    });

    function renderMap(){
      const selMonth = document.getElementById("filter-month").value;
      if(!selMonth){
        document.getElementById("map").innerHTML = "<p style='color:#666;'>Please select a month.</p>";
        return;
      }
      const filtered = withCoords.filter(d => d.Month === selMonth);
      if(filtered.length === 0){
        document.getElementById("map").innerHTML = "<p style='color:#666;'>No data for the selected month.</p>";
        return;
      }
      if(!mapSpecTemplate){
        // spec hasn't loaded yet - show a placeholder (spec will be used once fetched)
        document.getElementById("map").innerHTML = "<p style='color:#666;'>Loading map definition...</p>";
        return;
      }

      // deep copy template so we don't mutate the loaded file in memory (helps re-use)
      const spec = JSON.parse(JSON.stringify(mapSpecTemplate));
      // try to find a named layer "aqi_points"
      let layerIdx = -1;
      if(Array.isArray(spec.layer)){
        for(let i=0;i<spec.layer.length;i++){
          if(spec.layer[i] && (spec.layer[i].name === "aqi_points" || spec.layer[i].name === "aqi_points")) { layerIdx = i; break; }
        }
        if(layerIdx === -1) layerIdx = 6; // fallback to original numbering
      } else {
        console.error("Spec.layer missing or not array");
        document.getElementById("map").innerHTML = "<p style='color:#b00;'>Invalid map spec (no layers).</p>";
        return;
      }

      // ensure data.values exists and set points
      if(!spec.layer[layerIdx].data) spec.layer[layerIdx].data = {};
      spec.layer[layerIdx].data.values = filtered;

      // embed to #map
      vegaEmbed("#map", spec, {actions: true, renderer: "canvas"}).catch(err => {
        console.error("vegaEmbed error:", err);
        document.getElementById("map").innerHTML = "<p style='color:#b00;'>Failed to render map.</p>";
      });
    }
  }).catch(err => {
    console.error("CSV load failed:", err);
    document.getElementById("map").innerHTML = "<p style='color:#b00;'>Failed to load map data.</p>";
  });

  // ---------------- Monthly Chart ----------------
  const CSV_URL="https://raw.githubusercontent.com/EeGwen/FIT3179-Data-Visualisation-2/refs/heads/main/data/air_pollution_with_month_year.csv";
  const MONTH_ORDER=["January","February","March","April","May","June","July","August","September","October","November","December"];
  const baseSpec={
    "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
    "autosize": {"type":"fit","contains":"padding"},
    "width":"container","height":480,
    "data":{"values":[]},
    "mark":{"type":"line","point":true,"clip":true},
    "encoding":{
      "x":{"field":"month","type":"ordinal","axis":{"title":"Month"},"scale":{"domain":MONTH_ORDER}},
      "y":{"field":"concentration_num","type":"quantitative","axis":{"title":"Concentration"}},
      "color":{"field":"year","type":"nominal","legend":{"title":"Year"}},
      "detail":[{"field":"year"},{"field":"pollutant"}],
      "tooltip":[
        {"field":"pollutant","type":"nominal","title":"Pollutant"},
        {"field":"year","type":"nominal","title":"Year"},
        {"field":"month","type":"ordinal","title":"Month"},
        {"field":"concentration_num","type":"quantitative","title":"Concentration"}]
    }
  };
  d3.csv(CSV_URL).then(rawData=>{
    const data = rawData.map(d=>({ date:d.date, pollutant:d.pollutant?.trim(), concentration_num:d.concentration?+d.concentration:null, month:d.month?.trim(), year:d.year?.trim() }));
    const cleaned=data.filter(d=>d.concentration_num!=null);
    const pollutants=Array.from(new Set(cleaned.map(d=>d.pollutant))).filter(Boolean).sort();
    const years=Array.from(new Set(cleaned.map(d=>d.year))).filter(Boolean).sort();

    const pollContainer=document.getElementById("pollutant-radios");
    pollutants.forEach((p,idx)=>{ const id="radio-"+p.replace(/\s+/g,"_"); const wrapper=document.createElement("div"); wrapper.innerHTML=`<label><input type="radio" name="pollutant" id="${id}" value="${p}" ${idx===0?'checked':''}> ${p}</label>`; pollContainer.appendChild(wrapper);});

    const yearContainer=document.getElementById("year-checkboxes");
    years.forEach(y=>{ const id="year-"+y; const wrapper=document.createElement("div"); wrapper.innerHTML=`<label><input type="checkbox" id="${id}" value="${y}" checked> ${y}</label>`; yearContainer.appendChild(wrapper); });

    document.getElementById("reset-btn").addEventListener("click",()=>{ pollContainer.querySelector('input[name="pollutant"]').checked=true; yearContainer.querySelectorAll('input[type="checkbox"]').forEach(ch=>ch.checked=true); render(); });
    pollContainer.addEventListener("change",render);
    yearContainer.addEventListener("change",render);

    render();
    function render(){
      const selectedPoll=document.querySelector('input[name="pollutant"]:checked')?.value;
      const selectedYears=Array.from(yearContainer.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value);
      if(!selectedPoll || selectedYears.length===0){ document.getElementById("chart").innerHTML="<p style='color:#666;'>Select pollutant and year(s).</p>"; return; }
      const filtered=cleaned.filter(d=>d.pollutant===selectedPoll && selectedYears.includes(d.year));
      if(filtered.length===0){ document.getElementById("chart").innerHTML="<p style='color:#666;'>No data for selection.</p>"; return; }
      const spec=JSON.parse(JSON.stringify(baseSpec)); spec.data={values:filtered};
      vegaEmbed("#chart",spec,{actions:true,renderer:"canvas"}).catch(err=>console.error(err));
    }
  });

  // ---------------- GHG Chart ----------------
  (function(){
    const GHG_CSV_URL="https://raw.githubusercontent.com/EeGwen/FIT3179-Data-Visualisation-2/refs/heads/main/data/ghg_emissions_with_year.csv";
    const SOURCE_LABELS={"total":"Total Emissions","net":"Net Emissions","energy":"Energy","industrial_processes":"Industrial Processes","agriculture":"Agriculture","waste":"Waste"};
    const ghgSpecTemplate={
      "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
      "autosize": {"type":"fit","contains":"padding"},
      "width":"container","height":480,
      "data":{"values":[]},
      "mark":{"type":"bar","tooltip":true,"clip":true},
      "encoding":{
        "x":{"field":"source","type":"nominal","axis":{"title":"Source","labelAngle":0}},
        "xOffset":{"field":"year","type":"nominal"},
        "y":{"field":"emissions_num","type":"quantitative","axis":{"title":"Emissions"}},
        "color":{"field":"year","type":"nominal","legend":{"title":"Year"}},
        "tooltip":[{"field":"source","type":"nominal","title":"Source (code)"},{"field":"source_full","type":"nominal","title":"Source (full)"},{"field":"year","type":"nominal","title":"Year"},{"field":"emissions_num","type":"quantitative","title":"Emissions"}]
      }
    };
    d3.csv(GHG_CSV_URL).then(raw=>{
      const parsed=raw.map(d=>({source:d.source?.trim(),emissions_num:d.emissions?+d.emissions:null,year:d.year?.trim(),source_full:SOURCE_LABELS[d.source?.trim()]||d.source})).filter(d=>d.emissions_num!=null && d.source && d.year);
      const years=Array.from(new Set(parsed.map(d=>d.year))).sort();
      const yearContainer=document.getElementById("ghg-year-checkboxes");
      yearContainer.innerHTML="";
      const allId="ghg-year-all";
      const allWrapper=document.createElement("div"); allWrapper.innerHTML=`<label><input type="checkbox" id="${allId}" checked> All</label>`; yearContainer.appendChild(allWrapper);
      years.forEach(y=>{ const id="ghg-year-"+y; const wrapper=document.createElement("div"); wrapper.innerHTML=`<label><input type="checkbox" id="${id}" value="${y}" checked> ${y}</label>`; yearContainer.appendChild(wrapper); });

      const legendDiv=document.getElementById("ghg-source-legend"); legendDiv.innerHTML="<strong>Source codes:</strong>";
      const ul=document.createElement("ul"); Object.entries(SOURCE_LABELS).forEach(([k,v])=>{ const li=document.createElement("li"); li.textContent=`${k} — ${v}`; ul.appendChild(li);}); legendDiv.appendChild(ul);

      yearContainer.addEventListener("change",()=>{ const allBox=document.getElementById(allId); const yearBoxes=Array.from(yearContainer.querySelectorAll('input[type="checkbox"]')).filter(i=>i.id!==allId); allBox.checked=yearBoxes.every(b=>b.checked); renderGHG(); });
      document.getElementById(allId).addEventListener("change",()=>{ const checked=document.getElementById(allId).checked; yearContainer.querySelectorAll('input[type="checkbox"]').forEach(ch=>ch.checked=checked); renderGHG(); });
      renderGHG();
      function renderGHG(){
        const selectedYears=Array.from(yearContainer.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value).filter(Boolean);
        const filtered=parsed.filter(d=>selectedYears.includes(d.year));
        if(filtered.length===0){ document.getElementById("ghg-chart").innerHTML="<p style='color:#666;'>No data for selected year(s)</p>"; return;}
        const spec=JSON.parse(JSON.stringify(ghgSpecTemplate)); spec.data.values=filtered;
        vegaEmbed("#ghg-chart",spec,{actions:true,renderer:"canvas"}).catch(err=>console.error(err));
      }
    });
  })();

  /* ---------------- AQI (x) vs Respiratory/Cardiovascular scatter ----------------
     Data URL: selected_100_concordant_rows.csv
  */
  (function(){
    const DATA_URL = "https://raw.githubusercontent.com/EeGwen/FIT3179-Data-Visualisation-2/refs/heads/main/data/selected_100_concordant_rows.csv";
    const containerId = "#aqi-cases-scatter";
    const noteEl = document.getElementById("aqi-cases-note");

    const COLORS = {
      respiratory: "#1f77b4", // blue
      cardio: "#ff7f0e"       // orange
    };

    function findColumn(columns, keywords) {
      const low = columns.map(c => c.toLowerCase());
      for (let k of keywords) {
        const kl = k.toLowerCase();
        const idxExact = low.indexOf(kl);
        if (idxExact !== -1) return columns[idxExact];
      }
      for (let c of columns) {
        for (let k of keywords) {
          if (c.toLowerCase().includes(k.toLowerCase())) return c;
        }
      }
      return null;
    }

    function toNum(v){
      if (v === null || v === undefined) return null;
      if (typeof v === "number") return isFinite(v) ? v : null;
      const s = String(v).trim();
      if (s === "") return null;
      const cleaned = s.replace(/,/g, "");
      const n = +cleaned;
      return isNaN(n) ? null : n;
    }

    d3.csv(DATA_URL).then(raw => {
      if(!raw || raw.length === 0){
        document.querySelector(containerId).innerHTML = "<p style='color:#666;'>No data found in the provided CSV.</p>";
        noteEl.textContent = "";
        return;
      }

      const columns = Object.keys(raw[0] || {});
      const aqiCol = findColumn(columns, ["AQI", "Air Quality Index", "air quality index", "aqi"]);
      const respCol = findColumn(columns, ["Respiratory", "Respiratory Cases", "Respiratory_Cases", "respiratory_cases", "respiratorycases"]);
      const cardioCol = findColumn(columns, ["Cardiovascular", "Cardiovascular Cases", "Cardio", "cardiovascular_cases", "cardiovascularcases"]);

      if(!aqiCol){
        document.querySelector(containerId).innerHTML = "<p style='color:#666;'>Could not detect an AQI column in dataset (looked for 'AQI' / 'Air Quality Index').</p>";
        noteEl.textContent = "";
        return;
      }
      if(!respCol && !cardioCol){
        document.querySelector(containerId).innerHTML = "<p style='color:#666;'>Could not detect Respiratory or Cardiovascular case columns in the dataset.</p>";
        noteEl.textContent = "";
        return;
      }

      const mapped = raw.map(r => {
        return {
          raw: r,
          AQI: toNum(r[aqiCol]),
          Respiratory: respCol ? toNum(r[respCol]) : null,
          Cardiovascular: cardioCol ? toNum(r[cardioCol]) : null
        };
      }).filter(d => d.AQI != null && (d.Respiratory != null || d.Cardiovascular != null));

      if(mapped.length === 0){
        document.querySelector(containerId).innerHTML = "<p style='color:#666;'>No rows with both AQI and either respiratory or cardiovascular counts found.</p>";
        noteEl.textContent = "";
        return;
      }

      function prepareDataFor(yKey) {
        const rows = mapped.filter(d => d[yKey] != null).map(d => {
          return {
            AQI: d.AQI,
            Cases: d[yKey]
          };
        });
        return rows;
      }

      function simpleLinReg(xs, ys){
        const n = xs.length;
        if(n === 0) return null;
        let sx=0, sy=0, sxy=0, sx2=0;
        for(let i=0;i<n;i++){ sx += xs[i]; sy += ys[i]; sxy += xs[i]*ys[i]; sx2 += xs[i]*xs[i]; }
        const denom = n * sx2 - sx * sx;
        if(denom === 0) return null;
        const slope = (n * sxy - sx * sy) / denom;
        const intercept = (sy - slope * sx) / n;
        return {slope, intercept};
      }

      function renderFor(selection) {
        const key = (selection === "respiratory") ? "Respiratory" : "Cardiovascular";
        const displayRows = prepareDataFor(key);
        if(displayRows.length === 0){
          document.querySelector(containerId).innerHTML = `<p style="color:#666;">No rows with ${key} cases and AQI found.</p>`;
          noteEl.textContent = "";
          return;
        }

        const xs = displayRows.map(r => r.AQI);
        const ys = displayRows.map(r => r.Cases);
        const lr = simpleLinReg(xs, ys);
        if(lr){
          noteEl.textContent = `Regression (approx): ${key} = ${lr.slope.toFixed(4)} × AQI + ${lr.intercept.toFixed(4)} — based on ${displayRows.length} rows`;
        } else {
          noteEl.textContent = `Data loaded: ${displayRows.length} rows (regression not available)`;
        }

        const yTitle = (key === "Respiratory") ? "Respiratory Cases" : "Cardiovascular Cases";
        const pointColor = (selection === "respiratory") ? COLORS.respiratory : COLORS.cardio;
        const lineColor = pointColor;

        const spec = {
          "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
          "description": `AQI vs ${yTitle} with regression line`,
          "autosize": {"type":"fit","contains":"padding"},
          "width": "container",
          "height": 480,
          "data": {"values": displayRows},
          "layer": [
            {
              "mark": {"type":"point", "filled": true, "opacity": 0.65, "size": 60, "stroke": "#ffffff", "strokeWidth": 0.6},
              "encoding": {
                "x": {"field": "AQI", "type": "quantitative", "title": "Air Quality Index (AQI)"},
                "y": {"field": "Cases", "type": "quantitative", "title": yTitle},
                "tooltip": [
                  {"field":"AQI","type":"quantitative","title":"AQI"},
                  {"field":"Cases","type":"quantitative","title": yTitle}
                ],
                "color": {"value": pointColor}
              }
            },
            {
              "transform": [
                {
                  "regression": "Cases",
                  "on": "AQI",
                  "params": false,
                  "as": ["AQI", "Cases_reg"]
                }
              ],
              "mark": {"type":"line", "interpolate":"linear", "strokeWidth": 3},
              "encoding": {
                "x": {"field":"AQI","type":"quantitative"},
                "y": {"field":"Cases_reg","type":"quantitative"},
                "color": {"value": lineColor}
              }
            }
          ],
          "config": {
            "axis": {"labelFontSize": 12, "titleFontSize": 13},
            "title": {"fontSize": 14}
          }
        };

        vegaEmbed(containerId, spec, {actions: true, renderer: "canvas"})
          .catch(err => {
            console.error("Failed to render AQI vs cases plot:", err);
            document.querySelector(containerId).innerHTML = "<p style='color:#666;'>Failed to render chart.</p>";
          });
      }

      // wire up radio inputs
      const radios = document.querySelectorAll('input[name="caseType"]');
      radios.forEach(r => r.addEventListener('change', ()=>{
        const val = document.querySelector('input[name="caseType"]:checked').value;
        renderFor(val);
      }));

      // initial render
      const initial = document.querySelector('input[name="caseType"]:checked')?.value || "respiratory";
      renderFor(initial);

    }).catch(err => {
      console.error("Failed to load selected_100_concordant_rows.csv:", err);
      document.querySelector("#aqi-cases-scatter").innerHTML = "<p style='color:#666;'>Failed to load data.</p>";
      document.getElementById("aqi-cases-note").textContent = "";
    });
  })();

}); 
</script>

</body>
</html>
