{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "autosize": { "type": "fit", "contains": "padding" },
  "width": "container",
  "height": 520,
  "projection": { "type": "equalEarth" },
  "layer": [
    {
      "name": "ocean",
      "data": {
        "values": {
          "type": "FeatureCollection",
          "features": [
            {
              "type": "Feature",
              "geometry": { "type": "Sphere" }
            }
          ]
        }
      },
      "mark": { "type": "geoshape", "stroke": null },
      "encoding": {
        "color": { "value": "#e6f2ff" }
      }
    },
    {
      "name": "countries",
      "data": {
        "url": "https://raw.githubusercontent.com/EeGwen/FIT3179-Data-Visualisation-2/refs/heads/main/js/ne_110m%20(1).json",
        "format": { "type": "topojson", "feature": "ne_110m_admin_0_countries" }
      },
      "transform": [
        {
          "lookup": "properties.NAME",
          "from": {
            "data": {
              "url": "https://raw.githubusercontent.com/EeGwen/FIT3179-Data-Visualisation-2/refs/heads/main/data/Average_AQI_by_Country.csv"
            },
            "key": "Country",
            "fields": ["Average AQI", "AQI Category", "Cities Count"]
          }
        },
        {
          "calculate": "datum['Cities Count'] == null ? 'none' : (datum['Cities Count'] >= 3 ? 'high' : 'low')",
          "as": "coverage"
        },
        {
          "calculate": "datum['Average AQI'] == null ? 'No data' : datum['AQI Category']",
          "as": "map_category"
        }
      ],
      "mark": { "type": "geoshape", "stroke": "#565656", "strokeWidth": 0.35 },
      "encoding": {
        "color": {
          "field": "map_category",
          "type": "nominal",
          "scale": {
            "domain": ["No data", "Good", "Moderate", "Unhealthy", "Very Unhealthy", "Hazardous"],
            "range": ["#b3b3b3", "#f3eefc", "#e0d0ff", "#c2a7ff", "#8f6bdb", "#4b2f8f"]
          },
          "legend": {
            "title": "AQI Category (Average AQI)",
            "orient": "bottom",
            "offset": 8,
            "labelExpr": "datum.label === 'No data' ? 'No data' : datum.label === 'Good' ? '0–50 (Good)' : datum.label === 'Moderate' ? '51–100 (Moderate)' : datum.label === 'Unhealthy' ? '101–200 (Unhealthy)' : datum.label === 'Very Unhealthy' ? '201–300 (Very Unhealthy)' : datum.label === 'Hazardous' ? '>=301 (Hazardous)' : datum.label"
          }
        },
        "opacity": {
          "condition": [
            { "test": "datum.coverage === 'high'", "value": 1 },
            { "test": "datum.coverage === 'low'", "value": 1 }
          ],
          "value": 1
        },
        "tooltip": [
          { "field": "properties.NAME", "type": "nominal", "title": "Country" },
          { "field": "Average AQI", "type": "quantitative", "title": "Average AQI" },
          { "field": "map_category", "type": "nominal", "title": "Map category" },
          { "field": "AQI Category", "type": "nominal", "title": "AQI Category" },
          { "field": "Cities Count", "type": "quantitative", "title": "Cities Count" },
          { "field": "coverage", "type": "nominal", "title": "Coverage" }
        ]
      }
    },

    {
      "name": "annotation-lines",
      "data": {
        "values": {
          "type": "FeatureCollection",
          "features": [
            {
              "type": "Feature",
              "geometry": {
                "type": "LineString",
                "coordinates": [
                  [132.0, 41.0],
                  [127.5, 36.0]
                ]
              },
              "properties": { "id": "sk-line" }
            },
            {
              "type": "Feature",
              "geometry": {
                "type": "LineString",
                "coordinates": [
                  [106.0, 8.0],
                  [102.0, 4.2]
                ]
              },
              "properties": { "id": "my-line" }
            }
          ]
        }
      },
      "mark": { "type": "geoshape", "stroke": "#333", "strokeWidth": 1.5, "fill": null, "opacity": 0.9 }
    },

    {
      "name": "annotation-text",
      "data": {
        "values": [
          { "lon": 132.0, "lat": 41.0, "id": "sk", "label": "South Korea has hazardous AQI" },
          { "lon": 106.0, "lat": 8.0, "id": "my", "label": "Malaysia has moderate AQI" }
        ]
      },
      "mark": { "type": "text", "fontSize": 12, "fontWeight": "bold", "align": "left", "dx": 6, "dy": -2 },
      "encoding": {
        "longitude": { "field": "lon", "type": "quantitative" },
        "latitude": { "field": "lat", "type": "quantitative" },
        "text": { "field": "label", "type": "nominal" },
        "color": { "value": "#111" }
      }
    }

  ],
  "config": {
    "view": { "stroke": "transparent" },
    "background": "#e6f2ff"
  }
}
